{% if user and user.is_authenticated %}
    <script type="text/javscript">
        function showNextComplaint(evt){
            require(["dojo/dom",
                    "dojo/request/xhr",
                    "dijit/registry"  ,
                    "dojo/json"       ,
                    "dojo/dom-form"   ,
                    "dijit/Dialog"    ,
                    'dojo/dom-class',
                    'dojo/dom-style',
                    'dojo/dom',
                    'dojo/query',
                    'dojo/NodeList-traverse',
                    'dojo/NodeList-data',
            ],
            function(dom, 
                    xhr, 
                    registry, 
                    JSON, 
                    domForm, 
                    Dialog, 
                    domClass,
                    domStyle,
                    dom,
                    query){
                var tableRows = query('.visitComplaintEditFormTable tbody tr');
                
                for(var i=0; i<=tableRows.length; i++){
                   var row = tableRows[i];
                   if (domStyle.get(row,'display') == 'none'){
                      domStyle.set(row, 'display','table-row');
//                       domStyle.set(query(row).children('span.showNextComplaint')[0],'display','none');
                      domClass.add(row,'shownVisitComplaintTableRow');
                      domClass.remove(row, 'hiddenVisitComplaintTableRow');
                      break;
                   }
                };
//                 alert("this will add a new complaint");
            });
        }

        function removeThisComplaint(evt){
            require(["dojo/dom",
                    "dojo/request/xhr",
                    "dijit/registry"  ,
                    "dojo/json"       ,
                    "dojo/dom-form"   ,
                    "dijit/Dialog"    ,
                    'dojo/dom-class',
                    'dojo/dom-style',
                    'dojo/dom',
                    'dojo/query',
                    'dojo/dom-attr',
                    'dojo/dom-construct',
                    'dojo/NodeList-traverse',
                    'dojo/NodeList-data'
            ],
            function(dom, 
                    xhr, 
                    registry, 
                    JSON, 
                    domForm, 
                    Dialog, 
                    domClass,
                    domStyle,
                    dom,
                    query,
                    domAttr,
                    domConstruct){

                var _delete = confirm("This will delete the complaint.. Proceed ?");
                if (_delete){
                  var rowQuery  = query(evt).closest('tr.shownVisitComplaintTableRow');
                  var delBtn    = query(evt).closest('.removeThisComplaint')[0];
                  var row       = rowQuery[0];
                  var allInputs = query(rowQuery).
                                    children('td').
                                    children('.dijitReset').
                                    children('.dijitInputContainer').
                                    children('input[type=text]');

                  if(row && domStyle.get(row,'display') == 'table-row'){
                    domStyle.set(row, 'display','none');
                    domClass.remove(row,'shownVisitComplaintTableRow');
                    domClass.add(row, 'hiddenVisitComplaintTableRow');
                    domConstruct.place(row,'visitComplaintEditFormTable','last');
                  }

                  allInputs.forEach(
                    function(input){
                      console.log(input);
                      domAttr.set(input,'value','');
                    }
                  );
                }else{
                  return false;
                }

            });
        }
    </script>

<div data-dojo-type = "dijit/form/Form" 
     id             = "newVisitEditForm_{{visit_detail_obj.id}}"
     data-dojo-id   = "newVisitEditForm_{{visit_detail_obj.id}}"
     encType        = "multipart/form-data" 
     action 	    =  "" 
     method         =  ""
     style          = "overflow: auto;"
     >


    <script type="dojo/method" data-dojo-event="onSubmit">
      if( this.validate() ){
        require(["dojo/dom",
                "dojo/request/xhr",
                "dijit/registry"  ,
                "dojo/json"       ,
                "dojo/dom-form"   ,
                "dijit/Dialog" 
        ],
        function(dom, xhr, registry, JSON, domForm, Dialog){
          var editDialog  = registry.byId("editPatientDialog");
          var errorDialog = registry.byId("dialogJsonMessage");

          xhr(CHOSEN_PATIENT.visitedit ? CHOSEN_PATIENT.visitedit :"{{visit_detail_obj.get_edit_url}}",{
              handleAs: "text",
              method  : "POST",
              data    : domForm.toObject("newVisitEditForm_{{visit_detail_obj.id}}")
          }).then(
            function(json){
                var jsondata = JSON.parse(json);
                console.log(jsondata);
                if(jsondata.success == true){
                  publishInfo("Saved Successfully" );
                  editDialog.hide();
                  new buildVisitTree();
//                   registry.byId('visitPaneRSidebar').set('href',CHOSEN_PATIENT.visitsummary);
                  registry.byId('visitSummaryTab').set('href',CHOSEN_PATIENT.visitsummary);
                  new buildPatientTree();
                  new buildAdmissionTree();
                }
                else{
                  publishError("ERROR ! :" + jsondata.error_message );
                }
            },
            function(json){
                  var jsondata = JSON.parse(json); 
                  publishError("ERROR!: "+ jsondata.error_message );
            },
            function(evt){console.log("Edited Visit Successfully...")}
          );
        });
        return false;
      }
      else{
        return false;
      }
    </script>



{% if perms.visit.change_visitdetail %}

      <table id ="visitDetailEditFormTable_{{visit_detail_obj.id}}">
          <tr> 
            <td> Date        </td> <td>  {{visit_detail_form.visit_date}}      </td> 
          </tr> 
          <tr>
            <td> Physician   </td> <td>   {{visit_detail_form.op_surgeon}}       </td>
          </tr>
          <tr>
            <td> Referred    </td> <td>   {{visit_detail_form.referring_doctor}} </td> 
          </tr>
          <tr>
            <td> Nature   </td> <td>   {{visit_detail_form.consult_nature}} </td> 
          </tr>
          <tr>
            <td> Status   </td> <td>   {{visit_detail_form.status}}         </td> 
          </tr>
          <tr>
            <td> Remarks   </td> <td>   {{visit_detail_form.remarks}}         </td> 
          </tr>
      </table>

      <hr class="shadow_line">
    

      <table id       =   "visitComplaintEditFormTable" 
             class="content_pane_table visitComplaintEditFormTable">
        {{ visit_complaint_formset.management_form }}

        <thead> 
          <tr> 
                <th> Complaint </th> 
                <th> Duration  </th> 
                <th>     &nbsp;&nbsp;      </th>
          </tr>
        </thead>

        <tbody>
        {% for form in visit_complaint_formset %}
            {{ form.id }}
            <tr id    = "visitComplaintEditFormsetRow_{{forloop.counter}}"
                style = "display:{% if forloop.counter > complaint_count %}none{%else%}table-row{%endif%}"
                class = "{% if forloop.counter <= complaint_count %} 
                           shownVisitComplaintTableRow 
                         {%else%} 
                           hiddenVisitComplaintTableRow 
                         {% endif %};"
            >

                <td>{{ form.complaint }}</td>
                <td>{{ form.duration }}</td>
                <td> 
                      <span style  = "background-image: url({{STATIC_URL}}images/absent.png );
                                      background-repeat: no-repeat;
                                      background-size  : 16px 16px;
                                      background-color : white;
                                      width: 16px; 
                                      height: 16px; 
                                      cursor: pointer; 
                                      display:table-cell;
                                      "
                            id     = "removeVisitComplaint_{{form.id}}"
                            complaintid = "{{form.id}}"
                            class  = "removeThisComplaint"
                            title  = "Remove this Complaint"
                            onclick = "removeThisComplaint(this);"
                        >
                      </span>

                      {% if forloop.counter == complaint_count %}
                        <span style  = "background-image: url({{STATIC_URL}}images/add.png);
                                        background-repeat: no-repeat;
                                        background-size  : 16px 16px;
                                        background-color : white;
                                        width: 16px; 
                                        height: 16px; 
                                        cursor: pointer; 
                                        display:table-cell;
                                        "
                              id     = "addMoreVisitComplaint_{{form.id}}"
                              class  = "showNextComplaint"
                              title  = "Add more complaints"
                              onclick = "showNextComplaint(this);"
                            >

                        </span>
                      {%endif%}

                </td>
            </tr>
        {% endfor %}
        </tbody>
      </table>

      <div id            = "visitHistoryAndPhysicalExamEditBorderContainer_{{visit_detail_obj.id}}"
          data-dojo-id   = "visitHistoryAndPhysicalExamEditBorderContainer_{{visit_detail_obj.id}}"
          data-dojo-type = "dojox/layout/ContentPane"
          style          = "height: 30em; overflow:auto;"
      >
          <div id             = "visitHistoryAndPhysicalExamEditTabContainer_{{visit_detail_obj.id}}"
              data-dojo-id    = "visitHistoryAndPhysicalExamEditTabContainer_{{visit_detail_obj.id}}"
              data-dojo-type  = "dijit/layout/TabContainer"
              data-dojo-props = "tabPosition:'top',tabStrip: true"
          >
            <div id              = "visitHPIEditFormContentPane_{{visit_detail_obj.id}}"
                 data-dojo-id    = "visitHPIEditFormContentPane_{{visit_detail_obj.id}}"
                 data-dojo-type  = "dojox/layout/ContentPane"
                 data-dojo-props = "title:'HPI'"
            >
              <table id="visit_hpi_edit_form_table_{{visit_detail_obj.id}}"> 
                {{visit_hpi_form.hpi}}
              </table> 
            </div>

            <div id             = "visitROSEditFormContentPane_{{visit_detail_obj.id}}"
                    data-dojo-id   = "visitROSEditFormContentPane_{{visit_detail_obj.id}}"
                    data-dojo-type = "dojox/layout/ContentPane"
                    data-dojo-props = "title:'ROS'"
              >
                <table id              = "visitRosEditFormDiv_{{visit_detail_obj.id}}" 
                        style           = "margin: 10px;"
                        >
                      {{visit_ros_form.as_table}} 
                  </table>     
            </div>
            
            <div id             = "visitVitalsGenAndHEENTExamEditFormContentPane_{{visit_detail_obj.id}}"
                  data-dojo-id   = "visitVitalsGenAndHEENTExamEditFormContentPane_{{visit_detail_obj.id}}"
                  data-dojo-type = "dojox/layout/ContentPane"
                  data-dojo-props = "title:'Vitals, GE, HEENT'"
            >
                <table id              = "visitVitalsGenAndHEENTExamEditFormDiv_{{visit_detail_obj.id}}" 
                      style           = "margin: 10px;"
                      >

                </table>     
            </div>

            <div id             = "visitRespCVSExamEditFromContentPane_{{visit_detail_obj.id}}"
                  data-dojo-id   = "visitRespCVSExamEditFromContentPane_{{visit_detail_obj.id}}"
                  data-dojo-type = "dojox/layout/ContentPane"
                  data-dojo-props = "title:'Resp, CVS &amp; Abd'"
            >
              <table id              = "visitRespCVSAdbExamEditFromDiv_{{visit_detail_obj.id}}" 
                      style           = "margin: 10px;"
                      >

                </table>     
            </div>

            <div id             = "visitMSAndNeuroExamEditFromContentPane_{{visit_detail_obj.id}}"
                  data-dojo-id   = "visitMSAndNeuroExamEditFromContentPane_{{visit_detail_obj.id}}"
                  data-dojo-type = "dojox/layout/ContentPane"
                  data-dojo-props = "title:'Extremity &amp; Neuro'"
            >
              <table id              = "visitMSAndNeuroExamEditFromDiv_{{visit_detail_obj.id}}" 
                      style           = "margin: 10px;"
                      >

                </table>     
            </div>

    </div>

  </div>

{% endif %} 
    
    {% if perms.visit.change_visitdetail %}
    <button data-dojo-type = "dijit/form/Button" 
            data-dojo-props="iconClass: 'dijitEditorIcon dijitEditorIconSave'"
            type           = "submit" 
            name           = "editButton" 
            value          = "Edit">
      Edit
     </button>
    {%endif%}

    {% if perms.visit.delete_visitdetail %}
    <button data-dojo-type  = "dijit/form/Button" 
			data-dojo-props = "iconClass: 'dijitEditorIcon dijitEditorIconDelete'"    
            type            = "button"
            name            = "delVisit"
            id              = "delVisitBtn_{{visit_detail_obj.id}}">
      Delete
      <script type="dojo/method" data-dojo-event="onClick" data-dojo-args="evt">
        require(
          ["dojo/dom", 
            "dojo/_base/xhr",
            "dojo/json",
            "dijit/registry",
            "dijit/Dialog"
          ],
        function(dom, xhr, JSON, registry, Dialog){
            xhr.get({
              url: "{{visit_detail_obj.get_del_url}}",
              load: function(json){
                      var jsondata = JSON.parse(json)
                      if (jsondata.success == true){
                        publishInfo(jsondata.error_message);
                        registry.byId("editPatientDialog").hide();
                        if( registry.byId('VISIT_{{visit_detail_obj.id}}') ){
                          registry.byId('VISIT_{{visit_detail_obj.id}}').destroyRecursive(false);
                        }
                        new buildVisitTree();
//                      registry.byId('visitPaneRSidebar').set('href',CHOSEN_PATIENT.visitsummary);
                        registry.byId('visitSummaryTab').set('href',CHOSEN_PATIENT.visitsummary);
                        new buildPatientTree();
                        new buildAdmissionTree();
                      }else{
                         publishError(jsondata.error_message);
                      }
                    }
            });
        });
    </script>
    </button>
    {% endif %}


</div>
{% else %}
<p class="suggestion_text"> Please Login </p>
{% endif %}