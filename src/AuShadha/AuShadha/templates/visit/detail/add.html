{% if perms.visit.add_visitdetail %}
    
    <script type="text/javascript">

      var totalVisitComplaintForms = "{{visit_complaint_formset.total_form_count}}";

      var rowStart = '<tr>';
      var rowEnd   = '</tr>';

      var addComplaintsSnippet    = "{{complaint_add_icon_html|escapejs}}";      
      var removeComplaintsSnippet = "{{complaint_remove_icon_html|escapejs}}";      
      var actionButtonCells       = "<td class='actionCell'>"+removeComplaintsSnippet + addComplaintsSnippet+"</td>";

      var emptyVisitComplaintForm  = "{{visit_complaint_formset.empty_form|escapejs}}";
      var complaintHTML = "<td>{{visit_complaint_formset.empty_form.complaint|escapejs}}</td>";
      var durationHTML  = "<td>{{visit_complaint_formset.empty_form.duration|escapejs}}</td>";

//    var emptyVisitComplaintForm  = emptyVisitComplaintForm.replace(/__prefix__/g, totalVisitComplaintForms);

      require(["dojo/dom",
              'dojo/dom-construct',
              'dojo/dom-style',
              'dojo/query',
              "dojo/on",
              "dojo/parser",
              "dojo/dom-attr",
              'dojo/NodeList-traverse',
              'dojo/NodeList-data'              
      ],
      function(dom, 
              domConstruct,
              domStyle,
              query,
              on,
              parser,
              domAttr){

          bindAddMoreComplaintsClick();

          function bindAddMoreComplaintsClick(){
            query('.showNextComplaint').forEach(
            function(node){
              on(node,'click',onAddMoreComplaintsClick);
            });
          }

          function onAddMoreComplaintsClick(){
              totalVisitComplaintForms ++;

              var escapedComplaintHTML = complaintHTML.replace(/__prefix__/g,totalVisitComplaintForms);
              var escapedDurationHTML = durationHTML.replace(/__prefix__/g,totalVisitComplaintForms);
              var HTMLToInsert = rowStart + escapedComplaintHTML + escapedDurationHTML + actionButtonCells + rowEnd;
              var rowInserted = domConstruct.place(HTMLToInsert,query("#visitComplaintAddFormTable tbody")[0] );
              parser.parse(rowInserted);
              bindAddMoreComplaintsClick();

              var allRows = query("#visitComplaintAddFormTable tbody tr");
              var numRows = allRows.length;

              allRows.forEach(function(row){
                  var showComplaintIcon = query(row).
                                            children("td.actionCell").
                                            children("span.showNextComplaint");                  
                  if (showComplaintIcon){
                    if(allRows.indexOf(row)+1<numRows){
                      domStyle.set(showComplaintIcon[0], {'display':'none'});
                    }else if(allRows.indexOf(row)+1 ==numRows){
                      domStyle.set(showComplaintIcon[0], {'display':'table-cell'});
                    }
                  }
                });

              domAttr.set("id_form-TOTAL_FORMS",{'value':totalVisitComplaintForms});
          }

       });
    </script>

    <script type="text/javscript">
    /*
        function showNextComplaint(evt){
            require(["dojo/dom",
                    "dojo/request/xhr",
                    "dijit/registry"  ,
                    "dojo/json"       ,
                    "dojo/dom-form"   ,
                    "dijit/Dialog"    ,
                    'dojo/dom-class',
                    'dojo/dom-style',
                    'dojo/dom',
                    'dojo/query',
                    'dojo/NodeList-traverse',
                    'dojo/NodeList-data',
            ],
            function(dom, 
                    xhr, 
                    registry, 
                    JSON, 
                    domForm, 
                    Dialog, 
                    domClass,
                    domStyle,
                    dom,
                    query){
                var tableRows = query('.visitComplaintAddFormTable tbody tr');
                
                for(var i=0; i<=tableRows.length; i++){
                   var row = tableRows[i];
                   if (domStyle.get(row,'display') == 'none'){
                      domStyle.set(row, 'display','table-row');
//                       domStyle.set(query(row).children('span.showNextComplaint')[0],'display','none');
                      domClass.add(row,'shownVisitComplaintTableRow');
                      domClass.remove(row, 'hiddenVisitComplaintTableRow');
                      break;
                   }
                };
//                 alert("this will add a new complaint");
            });
        }
        */

        function removeThisComplaint(evt){
            require(["dojo/dom",
                    "dojo/request/xhr",
                    "dijit/registry"  ,
                    "dojo/json"       ,
                    "dojo/dom-form"   ,
                    "dijit/Dialog"    ,
                    'dojo/dom-class',
                    'dojo/dom-style',
                    'dojo/dom',
                    'dojo/query',
                    'dojo/dom-attr',
                    'dojo/dom-construct',
                    'dojo/NodeList-traverse',
                    'dojo/NodeList-data'
            ],
            function(dom, 
                    xhr, 
                    registry, 
                    JSON, 
                    domForm, 
                    Dialog, 
                    domClass,
                    domStyle,
                    dom,
                    query,
                    domAttr,
                    domConstruct){

                var rowQuery  = query(evt).closest('tr.shownVisitComplaintTableRow');
                var row       = rowQuery[0];
                var allInputs = query(rowQuery).
                                  children('td').
                                  children('.dijitReset').
                                  children('.dijitInputContainer').
                                  children('input[type=text]');

                if(row && domStyle.get(row,'display') == 'table-row'){
                  domStyle.set(row, 'display','none');
                  domClass.remove(row,'shownVisitComplaintTableRow');
                  domClass.add(row, 'hiddenVisitComplaintTableRow');
                  domConstruct.place(row,'visitComplaintAddFormTable','last');
                }

                allInputs.forEach(
                  function(input){
                    console.log(input);
                    domAttr.set(input,'value','');
                  }
                );

            });
        }
    </script>

<div data-dojo-type = "dijit/form/Form" 
     id             = "newVisitAddForm"
     data-dojo-id   = "newVisitAddForm"
     encType        = "multipart/form-data" 
     action         = "" 
     method         = ""
     style          = "height: 60em; min-width: 50em; overflow:auto;"
     >

    <script type="dojo/method" data-dojo-event="onReset">
        return true;
    </script>
    
    <script type="dojo/method" data-dojo-event="onSubmit">
      if( this.validate() ){
        require(["dojo/dom",
                "dojo/request/xhr",
                "dijit/registry"  ,
                "dojo/json"       ,
                "dojo/dom-form"   ,
                "dijit/Dialog"    ,

                'aushadha/panes/visit_edit_pane'
        ],
        function(dom, 
                 xhr, 
                 registry, 
                 JSON, 
                 domForm, 
                 Dialog, 
                 VISIT_EDIT_PANE ){
          var editDialog  = registry.byId("editPatientDialog");
          var errorDialog = registry.byId("dialogJsonMessage");

          xhr(CHOSEN_PATIENT.visitadd ? CHOSEN_PATIENT.visitadd :"{{patient_detail_obj.get_patient_visit_add_url}}",{
              handleAs: "text",
              method  : "POST",
              data    : domForm.toObject("newVisitAddForm")
          }).then(
            function(json){
                var jsondata = JSON.parse(json);
                console.log(jsondata);
                if(jsondata.success == true){
                  publishInfo("Saved Successfully" );
                  if(editDialog){
                    editDialog.hide();
                  }
                  new buildVisitTree();
//                registry.byId('visitPaneRSidebar').set('href',CHOSEN_PATIENT.visitsummary);
                  registry.byId('visitSummaryTab').set('href',CHOSEN_PATIENT.visitsummary);
                  new buildPatientTree();
                  new buildAdmissionTree();
                }
                else{
                  publishError("ERROR ! :" + jsondata.error_message );
                }
            },
            function(json){
                  var jsondata = JSON.parse(json); 
                  publishError("ERROR!: "+ jsondata.error_message );
            },
            function(evt){console.log("Adding Data Finished Successfully...")}
          );
        });
        return false;
      }
      else{
        return false;
      }
    </script>

  {% if perms.visit.add_visitdetail %}

      <div data-dojo-type="dijit/TitlePane" id="visitDetailAddForm_TitlePane"
           data-dojo-props="'title':'Visit Details'">
        <table id ="visitDetailAddFormTable">
            <tr> 
              <th> <label for="id_visit_date"> Date</label></th>
              <td> {{visit_detail_form.visit_date}} </td>
            </tr>
            <tr>           
              <th> <label for="id_op_surgeon">Physician</label>
              <td> {{visit_detail_form.op_surgeon}} </td>
            </tr>
            <tr>           
              <th> <label for="id_refering_doctor">Referred</label> </th>
              <td> {{visit_detail_form.referring_doctor}}</td>
            </tr>
            <tr>           
              <th> <label for="id_consult_nature"> Nature</label>
              <td> {{visit_detail_form.consult_nature}} </td>
            </tr>
            <tr>           
              <th> <label for="id_status"> Status</label></th>
              <td> {{visit_detail_form.status}} </td>
            </tr>

            <tr>
              <td>
                <button data-dojo-type="dijit/form/Button" 
                        type="button" 
                        data-dojo-id="showVisitRemarks"
                        data-dojo-props="iconClass:'attachment_small'"
                        onClick="showOrHideRemarks();"
                        >
                Remarks
                <script type="text/javascript">
                    function showOrHideRemarks(){
                      require(['dojo/on',
                              'dojo/dom',
                              'dijit/registry',
                              'dojo/dom-style',
                              'dojo/dom-class',
                              'dojo/dom-attr'
                            ], 
                      function(on,
                                dom,
                                registry,
                                domStyle,
                                domClass,
                                domAttr
                                ){
                        if (domStyle.get(dom.byId("visitRemarksCell"),'display') == 'none'){
                          domStyle.set(dom.byId("visitRemarksCell"), {display:'table-cell'});
      //                     domAttr.set(this,{'label':'Hide Remarks'});
                        }else{
                          domStyle.set(dom.byId("visitRemarksCell"), {display:'none'});
      //                     domAttr.set(this,{'label':'Show Remarks'});
                        }
                      });
                    }
                </script>
                </button>
              </td>
            </tr>
            </table>
           
            <table>
              <tr>
    <!--             <th> <label for="id_remarks"> Remarks</label> </th> -->
                <td style="display:none;" id="visitRemarksCell">
                  {{visit_detail_form.remarks}}
                </td>
              </tr>
            </table>

      <div>
        {% include 'visit/complaints/add.html' %}
      </div>
      <hr >

</div>
<div data-dojo-type="dijit/TitlePane" data-dojo-props="'title':'History &amp; Examinations','open': false">

<div id             = "visitHistoryAndPhysicalExamBorderContainer"
     data-dojo-id   = "visitHistoryAndPhysicalExamBorderContainer"
     data-dojo-type = "dojox/layout/ContentPane"
     style          = "height: 30em; overflow:auto;"
  >
     <div id             = "visitHistoryAndPhysicalExamTabContainer"
          data-dojo-id   = "visitHistoryAndPhysicalExamTabContainer"
          data-dojo-type = "dijit/layout/TabContainer"
          data-dojo-props = "tabPosition:'top',tabStrip: true"
     >
     
        <div id             = "visitHPIFormContentPane"
              data-dojo-id   = "visitHPIFormContentPane"
              data-dojo-type = "dojox/layout/ContentPane"
              data-dojo-props = "title:'HPI'"
        >
          <table id                =   "visitHpiAddFormDiv"
                  style           = "margin: 10px;"
            >
              {{visit_hpi_form.hpi}}
          </table>
      </div>
      
      <div id             = "visitROSFormContentPane"
              data-dojo-id   = "visitROSFormContentPane"
              data-dojo-type = "dojox/layout/ContentPane"
              data-dojo-props = "title:'ROS'"
        >
          <table id              = "visitRosAddFormDiv" 
                  style           = "margin: 10px;"
                  >
                {{visit_ros_form.as_table}} 
            </table>     
        </div>

        <div id             = "visitVitalsGenAndHEENTExamFormContentPane"
              data-dojo-id   = "visitVitalsGenAndHEENTExamFormContentPane"
              data-dojo-type = "dojox/layout/ContentPane"
              data-dojo-props = "title:'Vitals, GE, HEENT'"
        >
            <table id              = "visitVitalsGenAndHEENTExamAddFormDiv" 
                  style           = "margin: 10px;"
                  >

            </table>     
        </div>

        <div id             = "visitRespCVSExamFromContentPane"
              data-dojo-id   = "visitRespCVSExamFromContentPane"
              data-dojo-type = "dojox/layout/ContentPane"
              data-dojo-props = "title:'Resp, CVS &amp; Abd'"
        >
          <table id              = "visitRespCVSAdbExamAddFromDiv" 
                  style           = "margin: 10px;"
                  >

            </table>     
        </div>

        <div id             = "visitMSAndNeuroExamFromContentPane"
              data-dojo-id   = "visitMSAndNeuroExamFromContentPane"
              data-dojo-type = "dojox/layout/ContentPane"
              data-dojo-props = "title:'Extremity &amp; Neuro'"
        >
          <table id              = "visitMSAndNeuroExamAddFromDiv" 
                  style           = "margin: 10px;"
                  >

            </table>     
        </div>

      </div>
</div>
</div>


      <button data-dojo-type = "dijit/form/Button" 
            data-dojo-props="iconClass: 'dijitIconSave'"
            type           = "submit" 
            name           = "submitButton" 
            value          = "Add">
        Save
     </button>

      <button data-dojo-type = "dijit/form/Button" 
              type           = "submit" 
              name           = "save_and_attach_examinations"
              value          = "Save &amp; Attach Examinations"
              data-dojo-props= "iconClass: 'dijitIconSave'"
              >
        Save &amp; Attach Examinations
        <script type            = "dojo/connect" 
                data-dojo-event = "onClick" 
                data-dojo-args  = "evt"
        >
          //ADD_MORE_PATIENTS = true;
          ADD_MORE_ITEMS    = true;
          //ADD_AND_OPEN_CHAR = true
        </script>
      </button>

      <button data-dojo-type  = "dijit/form/Button" 
              data-dojo-props="iconClass: 'dijitIconClear'"
              type            = "reset">
        Reset
      </button>
  
  {% endif %}

</div>
{% else %}
<p class="suggestion_text"> Insufficient Permissions</p>
{% endif %}