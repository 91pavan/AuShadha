{% if user.is_authenticated %}

  {% if perms.visit %}
    {%if visit_obj_list %}
      <div style = "background    : white; 
                    height        : 2.5em; 
                    border        : solid 1px #aaa;
                    border-radius : 5px;
                    width         : 100%;
                    margin-bottom : 10px;
                   "
           id   = "visitSummaryNotesContainer">


        <div style = "position      : relative; 
                      left          : .5em; 
                      display       : inline-block;
                      white-space   : nowrap;
                      width         : 90%;
                     "
             id    = "visitSummaryNotesSettingsContainer">
          <span style = "position    : relative; 
                         float       : left; 
                         display     : inline-block; 
                         white-space : nowrap; 
                         margin      : 4px;
                        " 
                class = "dijitIconFilter">
          </span>
          Filter By : 
          <span id              = "visitSummaryFilterSelector"
                data-dojo-type  = "dijit/form/Select"
                data-dojo-id    = "visitSummaryFilterSelector"
                data-dojo-props = "required:true"
                class           = "visitSummaryFilterSelector"
            >
            <option name="All"                   value="all"      > All Visits           </option>
            <option name="Active Vists"          value="active"   > Active Visits        </option>
            <option name="Via Appointments"      value="appts"    > Via Appointments     </option>
            <option name="Walkins"               value="walkins"  > Walkins              </option>
            <option name="Emergency"             value="emer"     > Emergency            </option>
            <option name="Telephonic"            value="tele"     > Telephonic           </option>
            <option name="Complaints"            value="complaint"> Complaints           </option>
            <option name="Visit Status"          value="visit_status"> Visit Status      </option>
            <option name="Physician Consulted"   value="op_surgeon"> Physician Consulted </option>

            <script type="dojo/on" data-dojo-event="change" data-dojo-args="evt">
                    require(['dojo/dom',
                             'dojo/on',
                             'dojo/dom-style',
                             'dojo/dom-attr',
                             "dijit/registry",
                             "dojo/dom-class",
                             "dojo/query",
                             "dojo/NodeList-traverse",
                             "dojo/NodeList-data"
                           ],
                    function(dom,on,domStyle,domAttr, registry, domClass,query){
                        var filterValue = evt;
                        var allTp   = query('.visitSummaryTitlePane');
                        switch(evt){
                          case 'all':
                            allTp.forEach(function(node){
                              domStyle.set(node,{display:'block'});
                            });
                            domStyle.set('visitOpSurgeonFilterSelector',{display:'none'});                              
                            domStyle.set('visitStatusFilterSelector',{display:'none'});                                                          
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});                            
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});
                            break;
                          case 'complaint':
                            allTp.forEach(function(node){
                              domStyle.set(node,{display:'block'});
                            });
                            domStyle.set('visitOpSurgeonFilterSelector',{display:'none'});                              
                            domStyle.set('visitStatusFilterSelector',{display:'none'});                                                          
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});                            
                            domStyle.set('visitComplaintFilterSelector',{display:'inline-block',whiteSpace:'nowrap'});
                            break;
                          case 'active':
                            allTp.forEach(function(node){
                              if( domClass.contains(node, 'visit_isActive') ){
                                domStyle.set(node,{display:'block'});
                              }else{
                                domStyle.set(node,{display:'none'});
                              }
                            });
                            domStyle.set('visitOpSurgeonFilterSelector',{display:'none'});                              
                            domStyle.set('visitStatusFilterSelector',{display:'none'});                                                          
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});                            
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});
                            break;
                          case 'appts':
                            allTp.forEach(function(node){
                              if( domClass.contains(node, 'visit_hasFu') ){
                                domStyle.set(node,{display:'block'});
                              }else{
                                domStyle.set(node,{display:'none'});
                              }
                            });
                            domStyle.set('visitOpSurgeonFilterSelector',{display:'none'});                              
                            domStyle.set('visitStatusFilterSelector',{display:'none'});                                                          
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});                            
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});                            
                            break;
                          case 'walkins':
                            allTp.forEach(function(node){
                              if( domClass.contains(node, 'visit_hasNoFu') ){
                                domStyle.set(node,{display:'block'});
                              }else{
                                domStyle.set(node,{display:'none'});
                              }
                            });
                            domStyle.set('visitOpSurgeonFilterSelector',{display:'none'});                              
                            domStyle.set('visitStatusFilterSelector',{display:'none'});                                                          
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});                                                          
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});                            
                            break;
                          case 'emer':
                            allTp.forEach(function(node){
                              if( domClass.contains(node, 'visit_hasNoFu visitNature_emer') ){
                                domStyle.set(node,{display:'block'});
                              }else{
                                domStyle.set(node,{display:'none'});
                              }
                            });
                            domStyle.set('visitOpSurgeonFilterSelector',{display:'none'});                              
                            domStyle.set('visitStatusFilterSelector',{display:'none'});                                                          
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});                                                          
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});                            
                            break;
                          case 'tele':
                            allTp.forEach(function(node){
                              if( domClass.contains(node, 'visit_hasNoFu visitNature_tele') ){
                                domStyle.set(node,{display:'block'});
                              }else{
                                domStyle.set(node,{display:'none'});
                              }
                            });
                            domStyle.set('visitOpSurgeonFilterSelector',{display:'none'});                              
                            domStyle.set('visitStatusFilterSelector',{display:'none'});                                                          
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});                            
                            break;
                          case 'visit_status':
                            allTp.forEach(function(node){
                                domStyle.set(node,{display:'block'});
                            });
                            domStyle.set('visitStatusFilterSelector',{display:'inline-block',whiteSpace:'nowrap'});                              
                            domStyle.set('visitOpSurgeonFilterSelector',{display:'none'});                            
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});                            
                            break;
                          case 'op_surgeon':
                            allTp.forEach(function(node){
                                domStyle.set(node,{display:'block'});
                            });
                            domStyle.set('visitOpSurgeonFilterSelector',{display:'inline-block',whiteSpace:'nowrap'});                              
                            domStyle.set('visitStatusFilterSelector',{display:'none'});                            
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});                            
                            break;
                          default:
                            allTp.forEach(function(node){
                              domStyle.set(node,{display:'block'});
                            });
                            domStyle.set('visitOpSurgeonFilterSelector',{display:'none'});                              
                            domStyle.set('visitStatusFilterSelector',{display:'none'});                                                          
                            domStyle.set('visitComplaintFilterSelector',{display:'none'});                            
                        }
                    });
            </script>

          </span>

        {%if visit_obj_list %}
          <span id              = "visitComplaintFilterSelector"
                data-dojo-type  = "dijit/form/Select"
                data-dojo-id    = "visitComplaintFilterSelector"
                data-dojo-props = "required:true"
                class           = "visitComplaintFilterSelector"
                style           = "display:none;"
          >

              {% for visit_obj in visit_obj_list %}

                {% for visit_detail, visit_rel in visit_obj.iteritems %}

                  {% for complaint in visit_detail.get_visit_complaints %}

                    <option name = "{{complaint.complaint}}"  
                            value= "{{complaint.complaint}}"  > 
                            {{complaint.complaint}}  
                    </option>

                  {% endfor %}

                {% endfor%}

              {% endfor %}

            <script type="dojo/on" data-dojo-event="change" data-dojo-args="evt">
                    require(['dojo/dom',
                             'dojo/on',
                             'dojo/dom-style',
                             'dojo/dom-attr',
                             "dijit/registry",
                             "dojo/dom-class",
                             "dojo/query",
                             "dojo/NodeList-traverse",
                             "dojo/NodeList-data"
                           ],
                    function(dom,on,domStyle,domAttr, registry, domClass,query){
                        var filterValue = evt;
                        var allTp       = query('.visitSummaryTitlePane');
                        var className   = "visitComplaint_" + evt;
                        if(className){
                          allTp.forEach(function(node){
                            if(domClass.contains(node, className)){
                              domStyle.set(node,{display:'block'});
                            }else{
                              domStyle.set(node,{display:'none'});
                            }
                          });
                        }
                    });
            </script>

          
          </span>
        {% endif %}


        {%if visit_obj_list %}
          <span id              = "visitStatusFilterSelector"
                data-dojo-type  = "dijit/form/Select"
                data-dojo-id    = "visitStatusFilterSelector"
                data-dojo-props = "required:true"
                class           = "visitStatusFilterSelector"
                style           = "display:none;"
          >

              {% for visit_obj in visit_obj_list %}

                {% for visit_detail, visit_rel in visit_obj.iteritems %}

                    <option name = "{{visit_detail.status}}"  
                            value= "{{visit_detail.status}}"   > 
                            {{visit_detail.status}} 
                    </option>

                {% endfor%}

              {% endfor %}

            <script type="dojo/on" data-dojo-event="change" data-dojo-args="evt">
                    require(['dojo/dom',
                             'dojo/on',
                             'dojo/dom-style',
                             'dojo/dom-attr',
                             "dijit/registry",
                             "dojo/dom-class",
                             "dojo/query",
                             "dojo/NodeList-traverse",
                             "dojo/NodeList-data"
                           ],
                    function(dom,on,domStyle,domAttr, registry, domClass,query){
                        var filterValue = evt;
                        var allTp       = query('.visitSummaryTitlePane');
                        var className   = "visitStatus_" + evt;
                        if(className){
                          allTp.forEach(function(node){
                            if(domClass.contains(node, className)){
                              domStyle.set(node,{display:'block'});
                            }else{
                              domStyle.set(node,{display:'none'});
                            }
                          });
                        }
                    });
            </script>
          </span>
        {% endif %}




        {%if visit_obj_list %}
          <span id              = "visitOpSurgeonFilterSelector"
                data-dojo-type  = "dijit/form/Select"
                data-dojo-id    = "visitOpSurgeonFilterSelector"
                data-dojo-props = "required:true"
                class           = "visitOpSurgeonFilterSelector"
                style           = "display:none;"
          >

              {% for visit_obj in visit_obj_list %}

                {% for visit_detail, visit_rel in visit_obj.iteritems %}

                    <option name = "{{visit_detail.op_surgeon}}"  
                            value= "{{visit_detail.op_surgeon}}"   > 
                            {{visit_detail.op_surgeon}} 
                    </option>

                    {% comment %} 
                    #FIXME FU visit op surgeon listing not implemented. This has to be done
                      {% for visit_fu in visit_detail.has_fu_visits %}
                      <option name = "{{visit_fu.op_surgeon}}"  
                              value= "{{visit_fu.op_surgeon}}"   > 
                              {{visit_fu.op_surgeon}} 
                      </option>
                      {%endfor%}
                    {% endcomment %}

                {% endfor%}

              {% endfor %}

            <script type="dojo/on" data-dojo-event="change" data-dojo-args="evt">
                    require(['dojo/dom',
                             'dojo/on',
                             'dojo/dom-style',
                             'dojo/dom-attr',
                             "dijit/registry",
                             "dojo/dom-class",
                             "dojo/query",
                             "dojo/NodeList-traverse",
                             "dojo/NodeList-data"
                           ],
                    function(dom,on,domStyle,domAttr, registry, domClass,query){
                        var filterValue = evt;
                        var allTp       = query('.visitSummaryTitlePane');
                        var className   = "visitOPSurgeon_" + evt;
                        if(className){
                          allTp.forEach(function(node){
                            if(domClass.contains(node, className)){
                              domStyle.set(node,{display:'block'});
                            }else{
                              domStyle.set(node,{display:'none'});
                            }
                          });
                        }
                    });
            </script>
          </span>
        {% endif %}


          <span style = "background-color : white;
                         background-size  : 16px 16px;
                         background-repeat: no-repeat;
                         background-image : url('{{STATIC_URL}}images/generic/dashboard_and_settings/settings_16.png');
                         position         : relative;
                         top              : -16px;
                         float            : right;
                         cursor           : pointer;
                         width            : 16px;
                         height           : 16px;
                         margin           : 0px 3px 0px 3px;
                        " 
                title = "Show Settings"
                onClick="showVisitNotesSettingsDiv(this);"
                >

                <script type           = "dojo/method" >
                  function showVisitNotesSettingsDiv(e){
                    require(['dojo/dom',
                             'dojo/on',
                             'dojo/dom-style',
                             'dojo/dom-attr'
                           ],
                    function(dom,on,domStyle,domAttr){
                             if(domStyle.get('visitSummaryNotesSettings','display')== 'none'){
                              domStyle.set('visitSummaryNotesSettings',
                                            {display      : 'block',
                                             marginBottom : '10px'
                                            }
                              );
                             }else{
                              domStyle.set('visitSummaryNotesSettings',
                                            {display:'none'}
                              );
                             }
                    });
                  }

                  function openVisitNotesTitlePane(evt){
                    require(["dijit/registry",
                            'dijit/TitlePane',
                            'dojo/on',
                            'dojo/dom',
                            "dojo/dom-attr",
                            "dojo/dom-style",
                            "dojo/query",
                            "dojo/window",
                            "dojo/NodeList-traverse",
                            "dojo/NodeList-data"
                            ], 
                    function(registry,
                              TitlePane,
                              on,
                              dom,
                              domAttr,
                              domStyle,
                              query,
                              win){
                      var thisId = domAttr.get(evt,'titlePaneId');
                      var tP     = registry.byId(thisId);
                      if(!tP.open){ 
                         tP.toggle();
                      }
                      win.scrollIntoView(dom.byId(thisId));
                      query('.visitSummaryTitlePane').
                      forEach(
                        function(node){
                          var nodeId = domAttr.get(node,'id');
                          if(nodeId != thisId){
                            var notTP = registry.byId(nodeId);
                            if(notTP.open){
                              notTP.toggle();
                            }
                          }
                        });
                    });
                  }

              </script>
          </span>

          <span style = "background-color : white;
                         background-size  : 16px 16px;
                         background-repeat: no-repeat;
                         background-image : url('{{STATIC_URL}}images/silk/icons/application_get.png');
                         position         : relative;
                         top              : -16px;
                         float            : right;
                         cursor           : pointer;
                         width            : 16px;
                         height           : 16px;
                         margin           : 0px 3px 0px 3px;
                        " 
                title   = "Show All Visit Notes in a Popup"
                id      = "showVisitSummaryNotes"
                onClick = 'showVisitNotesDialog();'
                >
                <script type           = "dojo/method" >
                  function showVisitNotesDialog(){
                    require(['dijit/registry',
                           'dojo/dom',
                           'dojo/on',
                           'dojo/dom-style',
                           'dijit/Dialog'
                           ],
                    function(registry,dom,on,domStyle,Dialog){
                              registry.byId('visitSummaryHiddenDiv').show();
                              /*
                              try{
                                domStyle.set('visitSummaryHiddenDiv_underlay',
                                           {opacity:'0',zIndex:'-1',display:"none"}
                                );
                              }catch(err){
                                  console.log(err.message);
                              }
                              console.log("Popup Styling complete");
                              */
                    });
                  }
                </script>
          </span>
          
          <span style = "background-color : white;
                         background-image : url('{{STATIC_URL}}images/patient_past_history.png');
                         background-size  : 16px 16px;
                         background-repeat: no-repeat;
                         position         : relative;
                         top              : -16px;
                         float            : right;
                         cursor           : pointer;
                         width            : 16px;
                         height           : 16px;
                         margin           : 0px 3px 0px 3px;
                        " 
                title = "Problem List"
                onClick="showVisitComplaints(this);"
                >
                <script type           = "dojo/method" >
                  function showVisitComplaints(){
                    require(['dijit/registry',
                           'dojo/dom',
                           'dojo/on',
                           'dijit/Dialog',
                           "aushadha/dialog/NonModalDialog"
                           ],
                    function(registry,dom,on,Dialog,NonModalDialog){
                              registry.byId('visitComplaintsHiddenDiv').show();
                              console.log(registry.byId('visitComplaintsHiddenDiv'));
                    });
                  }
                </script>
          </span>
          
          <span style = "background-color : white;
                         background-image : url('{{STATIC_URL}}images/archive.png');
                         background-size  : 16px 16px;
                         background-repeat: no-repeat;
                         position         : relative;
                         top              : -16px;
                         float            : right;
                         cursor           : pointer;
                         width            : 16px;
                         height           : 16px;
                         margin           : 0px 3px 0px 3px;
                        " 
                title = "Show History Summary"
                onClick="showHistorySummary(this);"
                >
                <script type           = "dojo/method" >
                  function showHistorySummary(){
                    require(['dijit/registry',
                           'dojo/dom',
                           'dojo/on',
                           'dijit/Dialog'
                           ],
                    function(registry,dom,on,Dialog){
                              var historyHTML = dom.byId('patientSynopsisTopContentPane').innerHTML;
                              new Dialog({content : historyHTML,
                                          title   : "History Summary: '{{patient_detail_obj}}'"}
                              ).show();
                    });
                  }
                </script>
          </span>
          
        </div>
      </div>
      
    {% endif %}
  {% endif %}

  <div id="visitSummaryNotesSettings" 
       style="display       : none;
              position      : relative;
              top           : 0;
              background    : white;
              border        : solid 1px #aaa;
              border-radius : 5px;
              padding       : 0px 5px 0px 10px;
              "
              >
    <button id              = "visitShowTimeLineButton"
            data-dojo-type  = "dijit/form/Button"
            data-dojo-id    = "visitShowTimeLineButton"
            class           = "visitShowTimeLineButton"
            type            = "button"
            data-dojo-props ="label:'Show Time Line'"
    >
      Show Time Line
    </button>


    <button id              = "visitNotesCollapseExpandAllButton"
            data-dojo-type  = "dijit/form/Button"
            data-dojo-props = "label: 'Expand All'"
            data-dojo-id    = "visitNotesCollapseExpandAllButton"
            class           = "visitNotesCollapseExpandAllButton"
    >
      Expand
      <script type="dojo/on" data-dojo-args="evt" data-dojo-event="click">
            require(['dijit/registry'       ,
                    'dojo/dom'              ,
                    'dojo/on'               ,
                    'dojo/dom-style'        ,
                    "dojo/dom-attr"         ,
                    "dijit/TitlePane"       ,
                    "dojo/query"            ,
                    "dojo/NodeList-traverse",
                    "dojo/NodeList-data"
                    ],
            function(registry ,
                     dom      ,
                     on       ,
                     domStyle ,
                     domAttr  ,
                     TitlePane,
                     query){

               var btn     = registry.byId("visitNotesCollapseExpandAllButton");
               var btnLabl = registry.byId("visitNotesCollapseExpandAllButton").get('label');

               if ( btnLabl == "Expand All"){
                btn.set('label', "Collapse All");
                query('.visitSummaryTitlePane').
                forEach(function(node){
                          var nodeId = domAttr.get(node, 'id');
                          var tP     = registry.byId(nodeId);
                          if(!tP.open){ tP.toggle(); }
                       });
               }else{
                btn.set('label',"Expand All");
                query('.visitSummaryTitlePane').
                forEach(function(node){
                          var nodeId = domAttr.get(node, 'id');
                          var tP     = registry.byId(nodeId);
                          if(tP.open){ tP.toggle(); }
                       });
               }
            });
      </script>
    </button>

  </div>

  <div id="visitSummaryDiv_{{patient_detail_obj.id}}">
  
    {%if visit_obj_list %}

      {% for visit_obj in visit_obj_list %}

        {% for visit_detail, visit_rel in visit_obj.iteritems %}

          <div data-dojo-type  = "dijit/TitlePane" 
               data-dojo-props = "title: '{{visit_detail.visit_date.date}}-{{visit_detail.op_surgeon}}', {% if forloop.counter == '1' %}open:true {%else%} open:false {%endif%}"
               id              = "visitSummaryTitlePane_{{visit_detail.id}}"
               class           = "visitSummaryTitlePane

                                  {%if visit_detail.is_active%}
                                     visit_isActive
                                  {%else%}
                                     visit_isNotActive
                                  {%endif%}

                                  visitStatus_{{visit_detail.status}}
                                  visitNature_{{visit_detail.consult_nature}}

                                  {% if visit_detail.get_visit_complaints%}
                                    {% for visitComplaint in visit_detail.get_visit_complaints%}
                                      visitComplaint_{{visitComplaint.complaint}}
                                    {%endfor%}
                                  {%endif%}

                                  {% if visit_detail.has_fu_visits %}
                                    visit_hasFu
                                  {%else%}
                                    visit_hasNoFu
                                  {%endif%}
                                  
                                  visitOPSurgeon_{{visit_detail.op_surgeon}}
                                  "
               >
            <div>
              <p>
              {% if visit_detail.is_active %}
                <img src   = "{{STATIC_URL}}images/flag_green.png" 
                    alt   = "ACTIVE VISIT" 
                    title = "Active Visit"
                    style = 'float:right; margin: 3px; width:16px; height:16px;'
                    >
              {%else%}
                <img src  = "{{STATIC_URL}}images/flag_red.png" 
                    alt  = "INACTIVE VISIT" 
                    title = "Visit Closed"
                    style = 'float:right;margin: 3px; width:16px; height:16px;'
                    >
              {%endif%}
              {% if visit_detail.has_fu_visits %}
              <img src   = "{{STATIC_URL}}images/generic/document/actions/redo.png" 
                  alt   = "Has Follow Up Visit" 
                  title = "Has Follow Up Visit"
                  style = 'float:right; margin: 3px; width:16px; height:16px;'
                  >
              {% else %}
              <img src   = "{{STATIC_URL}}images/forbidden.png" 
                  alt   = "No Follow Up Visit" 
                  title = "No Follow Up Visit"
                  style = 'float:right; margin: 3px; width:16px; height:16px;'
                  >
              {% endif %}
              </p>
              <p>
                  <span style="color : navy;
                              font-weight : bold;"> 
                      Date:
                  </span> 
                  {{visit_detail.visit_date.date}}  - {{visit_detail.op_surgeon}}
              </p>
              <p> {{visit_detail.visit_nature}} ( {{visit_detail.visit_status}} ) </p>
              {% if visit_detail.remarks != 'NAD' %}
                <p style="font-weight: bold;">
                  Remarks:
                </p>  
                <p style="padding-left : 15px; 
                          line-height  : 1.6em; 
                          text-align   : justify;
                          ">
                    {{visit_detail.remarks.capitalize}} 
                </p>
              {% endif %}
            </div>

            <div> 
              {% for obj, obj_list in visit_rel.iteritems %}
                <table>
                    <thead>
                      <tr>
                        <th style="font-weight: bold;"> {{obj.upper}}</th> 
                      </tr>
                    </thead>
                    <tbody>
                    <tr>
                      <td style="padding-left : 15px; 
                                line-height  : 1.6em; 
                                text-align   : justify;
                                ">
                        {% for item in obj_list %}
                              {{item}}
                        {% endfor %}
                      </td>
                    </tr>
                    </tbody>
                </table>
              {% endfor %}
            </div>

            {% if visit_detail.has_fu_visits %}
              <span style="font-weight : bold; 
                          background   : #fff; 
                          width        : 100%; 
                          text-align   : center;
                          "> 
                Follow Ups 
              </span>
              {% for fu in visit_detail.has_fu_visits %}
                <div class="follow_up" style="background    : white; 
                                              border        : solid 1px #aaa; 
                                              border-radius : 5px; 
                                              position      : relative; 
                                              left          : .4em;
                                              padding       : .2em;
                                              margin        : .2em;
                                              line-height   : 2.1em;
                                              ">

                    {{fu.formatted_obj|safe}}  

                  {% comment %} 
                  <table >
                    <tr><th>Seen On    </th><td> {{fu.visit_date.date.isoformat}} </td></tr>
                    <tr><th>Seen By    </th><td> {{fu.op_surgeon}}                </td></tr>
                    <tr><th>Subjective </th><td> {{fu.subjective|safe}}           </td></tr>
                    <tr><th>Objective  </th><td> {{fu.objective|safe}}            </td></tr>
                    <tr><th>Assessment </th><td> {{fu.assessment|safe}}           </td></tr>
                    <tr><th>Plan       </th><td> {{fu.plan|safe}}                 </td></tr>
                  </table>
                  {% endcomment %}

                </div>
              {% endfor %}
            {% endif %}
          </div>
<!--           <hr class="shadow_line"> -->
      {% endfor %}

    {% endfor %}

    {% else %}
      <p> No OPD visits recorded for this Patient </p>
      <hr>      
    {% endif %}

  </div>

  <div data-dojo-id   = "visitComplaintsHiddenDiv" 
       data-dojo-type = "dijit/Dialog"
       data-dojo-props = "title:'Problem List for: {{patient_detail_obj}}'"
       id             = "visitComplaintsHiddenDiv" 
       class          = "hiddenVisitNotes" style="display:none;">
       {%if visit_obj_list %}
        <table class="content_pane_table"
          >
          <thead >
            <tr > 
              <th> No               </th> 
              <th> Date             </th>
              <th> Nature           </th> 
              <th> Status           </th> 
              <th> Complaint        </th> 
              <th> Duration         </th>
              <th> Follow-ups       </th> 
              <th> Active ?         </th> 
            </tr>
          </thead>
          <tbody>
          {% for complaint in patient_detail_obj.get_patient_complaints %}
              <tr class="{%cycle even_row,odd_row %} 
                         {%if complaint.visit_detail.is_active%}
                           visit_isActive
                         {%else%}
                           visit_isNotActive
                         {%endif%}
                         visitStatus_{{complaint.visit_detail.status}}
                         visitNature_{{complaint.visit_detail.consult_nature}}
                         visitComplaint_{{complaint.complaint}}
                         {% if complaint.visit_detail.has_fu_visits %}
                           visit_hasFu
                         {%else%}
                           visit_hasNoFu
                         {%endif%}
                         ">
                <td> {{forloop.counter}} </td>
                <td> 
                  <div id      = "openVisitNotes_{{complaint.visit_detail.id}}"
                       title       = "Open Visit Notes on Sidebar"
                       style       = "color:blue; cursor:pointer;"
                       class       = "openVisitNotesLink"
                       onClick     = "openVisitNotesTitlePane(this);"
                       titlePaneId = "visitSummaryTitlePane_{{complaint.visit_detail.id}}"
                    > 
                    {{complaint.visit_date}} 
                  </div>
                </td>
                <td> {{complaint.visit_detail.consult_nature}} </td>
                <td> {{complaint.visit_detail.status}} </td>
                <td> {{complaint.complaint}} </td>
                <td> {{complaint.duration}} </td>
                <td> 
                  {% if complaint.visit_fu %} 
                    {% for fu in complaint.visit_fu %}
                      <div id    = "visitComplaintsHiddenDiv_FU_details_{{fu.id}}" 
                           style = "margin:3px;padding:2px;"> 

                        <span title       = "Open Visit Notes on Sidebar"
                              style       = "color:blue; cursor:pointer;"
                              class       = "openVisitNotesLink"
                              onClick     = "openVisitNotesTitlePane(this);"
                              titlePaneId = "visitSummaryTitlePane_{{complaint.visit_detail.id}}"
                        >
                          {{fu.visit_date.date.isoformat }}
                        </span>

                      </div>

                      <div data-dojo-type  = "dijit/Tooltip"
                            data-dojo-props= "connectId : 'visitComplaintsHiddenDiv_FU_details_{{fu.id}}',
                                              position  : ['below']">
                          {{fu.formatted_obj|safe}}
                      </div>
                    {% endfor %}
                  {%else %}
                    No Follow ups.
                  {% endif %}
                </td>
                <td> {%if complaint.is_active %}  
                           Active
                    {% else %}  
                           Inactive
                    {% endif %} 
                </td>
              </tr>
          {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p> No OPD Visits Recorded</p>
      {% endif %}
  </div>
  
  <div data-dojo-id   = "visitSummaryHiddenDiv" 
       data-dojo-type = "dijit/Dialog"
       data-dojo-props = "title:'Visit Notes for: {{patient_detail_obj}}'"
       id             = "visitSummaryHiddenDiv" 
       class          = "hiddenVisitNotes" style="display:none;">
  
    {%if visit_obj_list %}

      {% for visit_obj in visit_obj_list %}

        {% for visit_detail, visit_rel in visit_obj.iteritems %}

          <div >
            <div>

              <span style="color        : navy;
                          font-weight   : bold;
                          background    : #eee;
                          padding       : 2px;
                          border        : solid 1px #aaa;
                          border-radius : 5px;
                          width         : 100%;
                          "> 
                  Date:{{visit_detail.visit_date.date}}  - {{visit_detail.op_surgeon}}
                  {% if visit_detail.is_active %}
                    <img src   = "{{STATIC_URL}}images/flag_green.png" 
                        alt   = "ACTIVE VISIT" 
                        title = "Active Visit"
                        style = 'float:right; width:16px; height:16px; margin:0px 3px 0px 3px;'
                        >
                  {%else%}
                    <img src   = "{{STATIC_URL}}images/flag_red.png" 
                        alt   = "INACTIVE VISIT" 
                        title = "Visit Closed"
                        style = 'float:right; width:16px; height:16px; margin:0px 3px 0px 3px;'
                        >
                  {%endif%}
                  {% if visit_detail.has_fu_visits %}
                  <img src   = "{{STATIC_URL}}images/generic/document/actions/redo.png" 
                      alt   = "Has Follow Up Visit" 
                      title = "Has Follow Up Visit"
                        style = 'float:right; width:16px; height:16px; margin:0px 3px 0px 3px;'
                      >
                  {% else %}
                  <img src   = "{{STATIC_URL}}images/forbidden.png" 
                      alt   = "No Follow Up Visit" 
                      title = "No Follow Up Visit"
                        style = 'float:right; width:16px; height:16px; margin:0px 3px 0px 3px;'
                      >
                  {% endif %}
              </span> 

              <p> {{visit_detail.visit_nature}} ( {{visit_detail.visit_status}} ) </p>
              {% if visit_detail.remarks != 'NAD' %}
                <p style="font-weight: bold;">
                  Remarks:
                </p>  
                <p style="padding-left : 15px; 
                          line-height  : 1.6em; 
                          text-align   : justify;
                          ">
                    {{visit_detail.remarks.capitalize}} 
                </p>
              {% endif %}
            </div>

            <div> 
              {% for obj, obj_list in visit_rel.iteritems %}
                <table>
                    <thead>
                      <tr>
                        <th style="font-weight: bold;"> {{obj.upper}}</th> 
                      </tr>
                    </thead>
                    <tbody>
                    <tr>
                      <td style="padding-left : 15px; 
                                line-height  : 1.6em; 
                                text-align   : justify;
                                ">
                        {% for item in obj_list %}
                              {{item}}
                        {% endfor %}
                      </td>
                    </tr>
                    </tbody>
                </table>
              {% endfor %}
            </div>

            {% if visit_detail.has_fu_visits %}
              <span style="font-weight : bold; 
                          background   : #fff; 
                          width        : 100%; 
                          text-align   : center;
                          "> 
                Follow Ups 
              </span>
              {% for fu in visit_detail.has_fu_visits %}
                <div class="follow_up" style="background    : white; 
                                              border        : solid 1px #aaa; 
                                              border-radius : 5px; 
                                              position      : relative; 
                                              left          : .4em;
                                              padding       : .2em;
                                              margin        : .2em;
                                              line-height   : 2.1em;
                                              ">

                    {{fu.formatted_obj|safe}}  

                  {% comment %} 
                  <table >
                    <tr><th>Seen On    </th><td> {{fu.visit_date.date.isoformat}} </td></tr>
                    <tr><th>Seen By    </th><td> {{fu.op_surgeon}}                </td></tr>
                    <tr><th>Subjective </th><td> {{fu.subjective|safe}}           </td></tr>
                    <tr><th>Objective  </th><td> {{fu.objective|safe}}            </td></tr>
                    <tr><th>Assessment </th><td> {{fu.assessment|safe}}           </td></tr>
                    <tr><th>Plan       </th><td> {{fu.plan|safe}}                 </td></tr>
                  </table>
                  {% endcomment %}

                </div>
              {% endfor %}
            {% endif %}
          </div>
<!--           <hr class="shadow_line"> -->
      {% endfor %}

    {% endfor %}

    {% else %}
      <p> No OPD visits recorded for this Patient </p>
      <hr>      
    {% endif %}

  </div>

{% else %}
  <hr>
  <p> Please login to view </p>
  <hr>
{% endif %}